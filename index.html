<!doctype html>
<html lang="en" style="background-color: #222529">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://www.unpkg.com/odyc@0.0.102/dist/index.global.js"></script>
    <script src="/main.js"></script>
    <script src="/map.js"></script>
    <title>Forest Hike | Memory minigame</title>
    <link rel="icon" type="image/png" href="/favicon.png" />
  </head>
  <body>
    <script>
      let currentLevel;

      function setDark() {
        game.loadMap(
          currentLevel.map
            .split("r")
            .join("R")
            .split("s")
            .join("S")
            .split("f")
            .join("F")
            .split("c")
            .join("C")
            .split(".")
            .join("-"),
        );
      }

      function setLight() {
        game.loadMap(currentLevel.map);
      }

      function getObsticleSprite(visible) {
        return {
          onEnter: async () => {
            setLight();
            await game.openDialog(
              "You missed a turn and got lost in the woods!",
            );
            game.player.position = [currentLevel.start.x, currentLevel.start.y];
          },
          solid: false,
          sprite: visible
            ? gameConfig.sprites.obsticle
            : gameConfig.sprites["road-dark"],
        };
      }

      function getRoadSprite(visible) {
        return {
          solid: false,
          sprite: visible
            ? gameConfig.sprites.road
            : gameConfig.sprites["road-dark"],
        };
      }

      function getCheckpointSprite(visible, step) {
        return {
          solid: false,
          onEnter: async (target) => {
            setLight();

            const isFinish = step == 3;
            if (isFinish) {
              let finishes = +(
                localStorage.getItem(currentLevel.difficulty) || "0"
              );
              finishes++;
              localStorage.setItem(currentLevel.difficulty, `${finishes}`);

              await game.openMessage(
                "<1>You finished one " +
                  currentLevel.difficulty +
                  " hike, good job!<1>\n\n\n<7>Press SPACE to go to main menu.<7>",
              );
              showTitleScreen();
              return;
            }

            const dialogs = localStorage.getItem("dialogs") || "yes";
            if (dialogs === "yes") {
              const msg =
                step === 1
                  ? "It's getting dark. Remember the route!"
                  : "What a nap! Let's continue the hike.";
              await game.openDialog(msg);
            }
          },
          onLeave: () => {
            setDark();
          },
          sprite: visible
            ? gameConfig.sprites.checkpoint
            : gameConfig.sprites["road-dark"],
        };
      }

      const game = odyc.createGame({
        screenWidth: 10,
        screenHeight: 10,
        cameraWidth: 10,
        cameraHeight: 10,
        background: "#000",
        messageColor: "#fff",
        messageBackground: "#222529",
        dialogBackground: "#222529",
        dialogColor: "#fff",
        dialogBorder: "#fff",
        dialogInternvalMs: 15,
        controls: {
          LEFT: ["KeyA", "ArrowLeft"],
          RIGHT: ["KeyD", "ArrowRight"],
          UP: ["KeyW", "ArrowUp"],
          DOWN: ["KeyS", "ArrowDown"],
          ACTION: ["Enter", "Space"],
        },
        cellWidth: gameConfig.cellWidth,
        cellHeight: gameConfig.cellHeight,
        colors: gameConfig.colors,
        map: ``,
        templates: {
          ".": getObsticleSprite(true),
          "-": getObsticleSprite(false),
          r: getRoadSprite(true),
          R: getRoadSprite(false),
          s: getCheckpointSprite(true, 1),
          S: getCheckpointSprite(false, 1),
          c: getCheckpointSprite(true, 2),
          C: getCheckpointSprite(false, 2),
          f: getCheckpointSprite(true, 3),
          F: getCheckpointSprite(false, 3),
        },
        player: {
          position: [0, 0],
          sprite: gameConfig.sprites.player,
        },
      });

      function setEmpty() {
        game.loadMap(`
          ..........
          ..........
          ..........
          ..........
          ..........
          ..........
          ..........
          ..........
          ..........
          ..........
        `);
        game.player.position = [-1, -1];
      }

      async function askDifficulty() {
        const dialogs = localStorage.getItem("dialogs") || "yes";
        const responseIndex = await game.prompt(
          "Easy",
          "Medium",
          "Hard",
          dialogs === "yes" ? "Hide dialogs" : "Show dialogs",
        );
        if (responseIndex === 3) {
          if (dialogs === "yes") {
            localStorage.setItem("dialogs", "no");
          } else {
            localStorage.setItem("dialogs", "yes");
          }
          return askDifficulty();
        }

        const difficulty = ["easy", "medium", "hard"][responseIndex];
        return difficulty;
      }

      async function showTitleScreen() {
        const easy = +(localStorage.getItem("easy") || "0");
        const medium = +(localStorage.getItem("medium") || "0");
        const hard = +(localStorage.getItem("hard") || "0");
        setEmpty();
        await game.openMessage(
          `<1>Forest Hike<1>\n<3>(memory minigame)<3>\n\n\nStay on the trail!\n\nLevels completed:\nEasy: ${easy}\nMedium: ${medium}\nHard: ${hard}\n\n\n<7>Press SPACE to start.<7>`,
        );

        const difficulty = await askDifficulty();

        const size =
          difficulty === "easy" ? 5 : difficulty === "medium" ? 7 : 10;

        let level = null;
        let i = 0;
        while (level === null && i < 100000) {
          level = generateRandomPath(10, 10, (size * size) / 2, size * 3, size);
          i++;
        }

        currentLevel = {
          start: level.start,
          end: level.end,
          map: convertPathToMap(level.path, 10),
          difficulty,
        };
        game.player.position = [currentLevel.start.x, currentLevel.start.y];
        setLight();
      }

      showTitleScreen();
    </script>
  </body>
</html>
